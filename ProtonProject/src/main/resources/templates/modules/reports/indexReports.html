<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">

<head>
   <title>Admin Page</title>
   <th:block th:include="addscripts"></th:block>
   <link rel = "stylesheet" href = "/App/css/modules/reports/reports-page.css">
</head>

<body>
   <!-- Include _menu.html -->
   <th:block th:include="_menu"></th:block>
	<div>
		<th:block th:if='${userProtonDetails.hasRole("ROLE_REPORTS_ADMIN") == true}'>
			<button id="admin-edit" class = "btn btn-pimary">Reports sources info</button>
			
			<div id = "reportsSourcesInfo">
				<div class = "row">
					
					<div class = "col-md-2" id = "reportsDatabases">
						<ul class = "databases" id = "databases">

						</ul>
					</div>

					<div class = "col-md-10" id = "reportsElements">
						<table id = "reportsTables" class = "table table-bordered">
							<thead>
								<tr>
									<th>Id</th>
									<th>Schema Name</th>
									<th>Table Name</th>
									<th>Create Date</th>
									<th>Update Date</th>
									<th>Is Active</th>
									<th>Alternate Name</th>
									<th>Description</th>
									<th>Config</th>
								</tr>
							</thead>
							<tbody>

							</tbody>
						</table>
					</div>
				</div>
			</div>
			<script>
				var databases = null;
				var tables = null;
				var liDatabases = "";
				var databaseTables= "";
				var existEditColumn = false;
				
				window.onload = function(){

					$.ajax({
						url : '/reports/control/getDatabases'
					}).done(function(data){
						databases = data;
						for(var i in databases){
							liDatabases += "<li data-id = '" + databases[i].id + "' onclick='getTables(this)'>" + databases[i].databaseName + "</li>";
						}

						$("#databases").append(liDatabases);
					})
					
				}

				function getTables(node){
					$.ajax({
							url : "/reports/control/getTables",
							data : {
								id : node.dataset.id
							}
						}).done(function(data){
							tables = data;
							var tablesText = "";
							for(var i in tables){
								tablesText += `<tr data-tableid = "` + tables[i].id + `">
												<td> ` + tables[i].id + `</td>
												<td> ` + tables[i].schemaName + `</td>
												<td> ` + tables[i].tableName + `</td>
												<td> ` + tables[i].cDate + `</td>
												<td> ` + tables[i].uDate + `</td>
												<td> ` + tables[i].isActive + `</td>
												<td> ` + tables[i].altName+ `</td>
												<td> ` + tables[i].description + `</td>
												<td> <button data-viewed="false" onclick = "getColumns(this)">Columns </button> </td>
											</tr>`;
							}
							$('#reportsTables tbody').empty().append(tablesText);
						})
				}

				function getColumns(node){

					if(node.dataset.viewed == "false"){
						var tableid = node.parentElement.parentElement.dataset.tableid;
						$.ajax({
							url : "/reports/control/getColumnsByTable",
							data : {
								id : tableid
							}
						}).done(function(data){

							testCols = data;

							data.sort(function(a, b){
								return a.id - b.id;
							})

							var tableStr = `<table class = "table table-bordered" data-tableid = '` + tableid + `'>
												<thead>
													<tr>
														<th> Id </th>
														<th> Column Name </th>
														<th> Description </th>
														<th> Alternate Name </th>
														<th> Is DictVal </th>
														<th> Is Active </th>
														<th> Create Date </th>
														<th> Update Date </th>
														<th> Is Need Encrypt </th>
													</tr>
												</thead>
												<tbody>`;

							for(var i in data){
								tableStr += `<tr>
												<td data-editable = "false" data-columnname = "id" data-edit = "false" data-type = "number" onclick = "changeColumnValue(this)" data-idcol = "`+ ("id" +i) + `"> ` + data[i].id + `</td>
												<td data-edit = "false" data-columnname = "columnName" data-type = "string" onclick = "changeColumnValue(this)" data-idcol = "`+ ("columnName" +i) + `"> ` + data[i].columnName + `</td>
												<td data-edit = "false" data-columnname = "description" data-type = "string" onclick = "changeColumnValue(this)" data-idcol = "`+ ("description" + i) + `"> ` + data[i].description + `</td>
												<td data-edit = "false" data-columnname = "altName" data-type = "string" onclick = "changeColumnValue(this)" data-idcol = "`+ ("altName" +i) + `"> ` + data[i].altName + `</td>
												<td data-edit = "false" data-columnname = "isDictVal" data-type = "boolean" onclick = "changeColumnValue(this)" data-idcol = "`+ ("isDictVal" + i) + `"> ` + data[i].isDictVal + `</td>
												<td data-edit = "false" data-columnname = "isActive" data-type = "boolean" onclick = "changeColumnValue(this)" data-idcol = "`+ ("isActive" + i) + `"> ` + data[i].isActive + `</td>
												<td data-edit = "false" data-columnname = "cDate" data-type = "date" onclick = "changeColumnValue(this)" data-idcol = "`+("cDate" + i) + `"> ` + data[i].cDate + `</td>
												<td data-edit = "false" data-columnname = "uDate" data-type = "date" onclick = "changeColumnValue(this)" data-idcol = "`+("uDate" + i) + `"> ` + data[i].uDate + `</td>
												<td data-edit = "false" data-columnname = "isNeedEncrypt" data-type = "boolean" onclick = "changeColumnValue(this)" data-idcol = "`+("isNeedEncrypt" + i) + `"> ` + data[i].isNeedEncrypt + `</td>
											</tr>`;

							}

							tableStr += "</tbody></table>";

							bootbox.dialog({
								title : "Columns",
								message : tableStr,
								size : 'large'
							})
						})
					}
				}

				function changeColumnValue(node){
					var type = node.dataset.type;
					console.log(node);
					if(!existEditColumn){
						existEditColumn = true;
						if(node.dataset.edit == "false"){
							node.dataset.edit = "true";
							if(type == "boolean"){
							var str = "<select class = 'selectpicker'>"
									+ "<option value = '1' " + (node.innerText == "true" ? 'selected' : '') + ">true</option>"
									+ "<option value = '0' " + (node.innerText == "false" ? 'selected' : '') + ">false</option>"
									+ "</select>";
							
							str += "<p><button class = 'reports-save' onclick='saveColumnToDb(this, \"selector\")'><i class='far fa-check-circle'></i></button>"
								+ "<button class = 'reports-cancel' data-val = '" + node.innerText + "' onclick = 'cancelSave(this)'><i class='fas fa-ban'></i></button></p>";
							
							$("[data-idcol='" + node.dataset.idcol + "']").empty().append(str);
								
							}
						}
					}
				}

				function saveColumnToDb(node, type){
					console.log(node);
					if(node.parentElement.parentElement.dataset.type == "boolean"){
						$.ajax({
							url : "/reports/control/updateColumn",
							data : {
								tableId : parseInt(node.offsetParent.offsetParent.dataset.tableid),
								columnId : parseInt(node.offsetParent.parentElement.children[0].innerText),
								param : node.offsetParent.dataset.columnname,
								columnValue : parseInt(node.offsetParent.children[0].value)
							}
						}).done(function(data){
							console.log(data);
						}).fail(function(e){
							console.log(e);
						})
					}
				}
			</script>
	    </th:block>
	</div>
	
   <script th:inline="javascript">
	   var testCols;
   </script>
</body>

</html>