<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">

<head>
   <title>Admin Page</title>
   <th:block th:include="addscripts"></th:block>
   <link rel = "stylesheet" href = "/App/css/modules/reports/reports-page.css">
   <link href="https://fonts.googleapis.com/css2?family=Pathway+Gothic+One&family=Rancho&display=swap" rel="stylesheet">
</head>

<body>
   <!-- Include _menu.html -->
   <th:block th:include="_menu"></th:block>
	<div>
		<th:block th:if='${userProtonDetails.hasRole("ROLE_REPORTS_ADMIN") == true}'>
			<button id="admin-edit" class = "btn btn-pimary">Reports sources info</button>
			
			<div id = "reportsSourcesInfo">
				<div class = "row">
					
					<div class = "col-md-2" id = "reportsDatabases">
						<ul class = "databases" id = "databases">

						</ul>
					</div>

					<div class = "col-md-10" id = "reportsElements">
						<table id = "reportsTables" class = "table table-bordered">
							<thead>
								<tr>
									<th>Id</th>
									<th>Schema Name</th>
									<th>Table Name</th>
									<th>Create Date</th>
									<th>Update Date</th>
									<th>Is Active</th>
									<th>Alternate Name</th>
									<th>Description</th>
									<th>Config</th>
								</tr>
							</thead>
							<tbody>

							</tbody>
						</table>
					</div>
				</div>
			</div>
			<script>
				var databases = null;
				var tables = null;
				var liDatabases = "";
				var databaseTables= "";
				var existEditColumn = false;
				
				window.onload = function(){

					$.ajax({
						url : '/reports/control/getDatabases'
					}).done(function(data){
						databases = data;
						for(var i in databases){
							liDatabases += "<li data-id = '" + databases[i].id + "' onclick='getTables(this)'>" + databases[i].databaseName + "</li>";
						}

						$("#databases").append(liDatabases);
					})
					
				}

				function getTables(node){
					$.ajax({
							url : "/reports/control/getTables",
							data : {
								id : node.dataset.id
							}
						}).done(function(data){
							tables = data;
							var tablesText = "";
							for(var i in tables){
								tablesText += `<tr data-tableid = "` + tables[i].id + `">
												<td data-editable = "false" data-columnname = "id" data-iddatabase="` + tables[i].idDatabase + `" data-edit = "false" data-type = "number" onclick = "changeTableColumn(this)" data-idcol = "`+ ("id" +i) + `tab"> ` + tables[i].id + `</td>
												<td data-columnname = "schema_ame" data-edit = "false" data-type = "string" onclick = "changeTableColumn(this)" data-idcol = "`+ ("schemaName" +i) + `tab"> ` + tables[i].schemaName + `</td>
												<td data-columnname = "table_name" data-edit = "false" data-type = "string" onclick = "changeTableColumn(this)" data-idcol = "`+ ("tableName" +i) + `tab"> ` + tables[i].tableName + `</td>
												<td data-columnname = "c_date" data-edit = "false" data-type = "date" onclick = "changeTableColumn(this)" data-idcol = "`+ ("cDate" +i) + `tab"> ` + tables[i].cDate + `</td>
												<td data-columnname = "u_date" data-edit = "false" data-type = "date" onclick = "changeTableColumn(this)" data-idcol = "`+ ("uDate" +i) + `tab"> ` + tables[i].uDate + `</td>
												<td data-columnname = "isActive" data-edit = "false" data-type = "boolean" onclick = "changeTableColumn(this)" data-idcol = "`+ ("isActive" +i) + `tab"> ` + tables[i].isActive + `</td>
												<td data-columnname = "alt_name" data-edit = "false" data-type = "string" onclick = "changeTableColumn(this)" data-idcol = "`+ ("altName" +i) + `tab"> ` + tables[i].altName+ `</td>
												<td data-columnname = "description" data-edit = "false" data-type = "string" onclick = "changeTableColumn(this)" data-idcol = "`+ ("description" +i) + `tab"> ` + tables[i].description + `</td>
												<td> <button data-viewed="false" onclick = "getColumns(this)">Columns </button> </td>
											</tr>`;
							}
							$('#reportsTables tbody').empty().append(tablesText);
						})
				}

				function getColumns(node){

					if(node.dataset.viewed == "false"){
						var tableid = node.parentElement.parentElement.dataset.tableid;
						$.ajax({
							url : "/reports/control/getColumnsByTable",
							data : {
								id : tableid
							}
						}).done(function(data){

							testCols = data;

							data.sort(function(a, b){
								return a.id - b.id;
							})

							var tableStr = `<table id = "columnTable" class = "table table-bordered" data-tableid = '` + tableid + `'>
												<thead>
													<tr>
														<th> Id </th>
														<th> Column Name </th>
														<th> Description </th>
														<th> Alternate Name </th>
														<th> Is DictVal </th>
														<th> Is Active </th>
														<th> Create Date </th>
														<th> Update Date </th>
														<th> Is Need Encrypt </th>
													</tr>
												</thead>
												<tbody>`;

							for(var i in data){
								tableStr += `<tr>
												<td data-editable = "false" data-columnname = "id" data-edit = "false" data-type = "number" onclick = "changeColumnValue(this)" data-idcol = "`+ ("id" +i) + `"> ` + data[i].id + `</td>
												<td data-edit = "false" data-columnname = "column_name" data-type = "string" onclick = "changeColumnValue(this)" data-idcol = "`+ ("columnName" +i) + `"> ` + data[i].columnName + `</td>
												<td data-edit = "false" data-columnname = "description" data-type = "string" onclick = "changeColumnValue(this)" data-idcol = "`+ ("description" + i) + `"> ` + data[i].description + `</td>
												<td data-edit = "false" data-columnname = "alt_name" data-type = "string" onclick = "changeColumnValue(this)" data-idcol = "`+ ("altName" +i) + `"> ` + data[i].altName + `</td>
												<td data-edit = "false" data-columnname = "isDictVal" data-type = "boolean" onclick = "changeColumnValue(this)" data-idcol = "`+ ("isDictVal" + i) + `"> ` + data[i].isDictVal + `</td>
												<td data-edit = "false" data-columnname = "isActive" data-type = "boolean" onclick = "changeColumnValue(this)" data-idcol = "`+ ("isActive" + i) + `"> ` + data[i].isActive + `</td>
												<td data-edit = "false" data-columnname = "c_date" data-type = "date" onclick = "changeColumnValue(this)" data-idcol = "`+("cDate" + i) + `"> ` + data[i].cDate + `</td>
												<td data-edit = "false" data-columnname = "u_date" data-type = "date" onclick = "changeColumnValue(this)" data-idcol = "`+("uDate" + i) + `"> ` + data[i].uDate + `</td>
												<td data-edit = "false" data-columnname = "is_need_encrypt" data-type = "boolean" onclick = "changeColumnValue(this)" data-idcol = "`+("isNeedEncrypt" + i) + `"> ` + data[i].isNeedEncrypt + `</td>
											</tr>`;

							}

							tableStr += "</tbody></table>";

							bootbox.dialog({
								title : "Columns",
								message : tableStr,
								size : 'large'
							})
						})
					}
				}

				function changeColumnValue(node){
					var type = node.dataset.type;
					console.log(node);
					if(!existEditColumn){
						existEditColumn = true;
						if(node.dataset.edit == "false"){
							node.dataset.edit = "true";
							var str = "";
							if(type == "boolean"){
								str = "<select class = 'selectpicker'>"
										+ "<option value = '1' " + (node.innerText == "true" ? 'selected' : '') + ">true</option>"
										+ "<option value = '0' " + (node.innerText == "false" ? 'selected' : '') + ">false</option>"
										+ "</select>";
								
							}else if(type == "string"){
								str = '<textarea>' + node.innerText + '</textarea>';
								
							}else if(type == "number"){
								str = '<input type = "number" value = ' + parseInt(node.innerText) + '>'
							}else if(type == "date"){
								str = '<input type = "date" value = "' + node.innerText + '">'
							}

							str += "<p><button class = 'reports-save' onclick='saveColumnToDb(this, \"selector\")'><i class='far fa-check-circle'></i></button>"
									+ "<button class = 'reports-cancel' data-val = '" + node.innerText + "' onclick = 'cancelSave(this)'><i class='fas fa-ban'></i></button></p>";
								$("[data-idcol='" + node.dataset.idcol + "']").empty().append(str);
						}
					}
				}

				function changeTableColumn(node){
					var type = node.dataset.type;
					if(!existEditColumn){
						existEditColumn = true;
						if(node.dataset.edit == "false"){
							node.dataset.edit = "true";
							var str = "";
							if(type == "boolean"){
								str = "<select class = 'selectpicker'>"
										+ "<option value = '1' " + (node.innerText == "true" ? 'selected' : '') + ">true</option>"
										+ "<option value = '0' " + (node.innerText == "false" ? 'selected' : '') + ">false</option>"
										+ "</select>";
								
							}else if(type == "string"){
								str = '<textarea>' + node.innerText + '</textarea>';
								
							}else if(type == "number"){
								str = '<input type = "number" value = ' + parseInt(node.innerText) + '>'
							}else if(type == "date"){
								str = '<input type = "date" value = "' + node.innerText + '">'
							}

							str += "<p><button class = 'reports-save' onclick='saveTableToDb(this, \"selector\")'><i class='far fa-check-circle'></i></button>"
									+ "<button class = 'reports-cancel' data-val = '" + node.innerText + "' onclick = 'cancelSave(this)'><i class='fas fa-ban'></i></button></p>";
								$("[data-idcol='" + node.dataset.idcol + "']").empty().append(str);
						}
					}
				}

				function cancelSave(node){
					$(node.offsetParent).empty().append(node.dataset.val);
				}

				function saveTableToDb(node, type){
					$.ajax({
						url : "/reports/control/updateTable",
						data : {
							tableId : parseInt(node.offsetParent.parentElement.children[0].innerText),
							databaseId : node.offsetParent.parentElement.children[0].dataset.iddatabase,
							field : node.offsetParent.dataset.columnname,
							value : convertVal(node.offsetParent.children[0].value, node.offsetParent.dataset.type)
						}
					}).done(function(data){
						$.growl.notice({
							title : 'Update succesful!',
							message : data
						});

						var stringAfter = "";

						if(type == 'boolean'){
							switch (node.offsetParent.children[0].value) {
								case 0:
									stringAfter = "false";
									break;
								case 1 :
									stringAfter = 'true';
									break;
								default:
									break;
							}
						}else{
							stringAfter = node.offsetParent.children[0].value;
						}

						$(node.offsetParent).empty().append(stringAfter);
					}).fail(function(e){
						$.growl.error({
							title : 'Error',
							message : e.responseText
						})
					});
				}

				function saveColumnToDb(node, type){
					$.ajax({
						url : "/reports/control/updateColumn",
						data : {
							tableId : parseInt(node.offsetParent.offsetParent.dataset.tableid),
							columnId : parseInt(node.offsetParent.parentElement.children[0].innerText),
							param : node.offsetParent.dataset.columnname,
							columnValue : convertVal(node.offsetParent.children[0].value, node.offsetParent.dataset.type)
						}
					}).done(function(data){
						$.growl.notice({
							title : 'Update succesful!',
							message : data
						});
						
						var stringAfter = "";

						if(type == 'boolean'){
							switch (node.offsetParent.children[0].value) {
								case 0:
									stringAfter = "false";
									break;
								case 1 :
									stringAfter = 'true';
									break;
								default:
									break;
							}
						}else{
							stringAfter = node.offsetParent.children[0].value;
						}

						$(node.offsetParent).empty().append(stringAfter);
					}).fail(function(e){
						$.growl.error({
							title : 'Error',
							message : e.responseText
						})
					})
				};

				function convertVal(value, type){
					var rvalue = "";
					if(type == "boolean"){
						rvalue = parseInt(value);
					}else if(type == "string"){
						rvalue = value;
					}else if(type == "number"){
						rvalue = parseInt(value);
					}else if(node.offsetParent.dataset.type == 'date'){
						rvalue = new Date(value);
					}
					return rvalue;
				}
			</script>
	    </th:block>
	</div>
	
   <script th:inline="javascript">
	   var testCols;
   </script>
</body>

</html>